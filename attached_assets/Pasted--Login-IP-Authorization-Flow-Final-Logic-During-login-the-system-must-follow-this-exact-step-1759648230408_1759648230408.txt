ğŸ” Login & IP Authorization Flow (Final Logic)

During login, the system must follow this exact step-by-step logic:

User clicks the Login button.

The backend checks the userâ€™s email and password against the database.

âŒ If credentials are invalid â†’ redirect the user to the Forgot Password page.

âœ… If valid â†’ continue to IP verification.

Fetch the userâ€™s current IP address from the login request using a reliable IP-fetching library such as:

request-ip
 (Node.js middleware), or

req.headers['x-forwarded-for'] || req.connection.remoteAddress as a fallback.

This ensures you always get the exact public IP address of the userâ€™s current device/network.

Retrieve the userâ€™s authorizedIPs array from the userâ€™s record in the MongoDB database.

Apply the following logic:

ğŸ§© Case 1: First-Time Login (Empty authorizedIPs array)

If authorizedIPs is empty:

Send a verification email to the userâ€™s registered email address.
The email should include:

The current IP address of the user.

An â€œAuthorize This IPâ€ button or link.

When the user clicks the link:

Verify the request source (must match the same IP that requested login).

If verified, add the IP address to the authorizedIPs array in the userâ€™s database record.

Allow login automatically.

âœ… Case 2: Known IP (Existing in authorizedIPs)

If the current IP address exists in the authorizedIPs array:

Proceed with direct login (no email verification needed).

âŒ Case 3: New IP Detected

If the current IP address is not found in the authorizedIPs array:

Send an email to the userâ€™s registered email address with:

The new IP address

The timestamp

An â€œAuthorize This IPâ€ button

When the user clicks the authorization link:

Verify that the IP in the request matches the IP stored during the email send.

Append the IP address to the userâ€™s authorizedIPs array.

Allow login from that IP in all future sessions.

This ensures:

The email confirmation flow runs only the first time for each new IP.

Once verified, that IP will never trigger another verification email unless removed manually.

Every verified IP is securely stored in MongoDB, making it easy to analyze user access patterns later.